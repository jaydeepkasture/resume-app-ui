<!-- Embedded History Sidebar -->
<div class="embedded-history-sidebar" [class.open]="historySidebarOpen">
  <div class="sidebar-header">
    <h3>History</h3>
    <button class="close-btn" (click)="toggleHistorySidebar()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>

  <div class="history-controls">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="historySearchQuery" 
        (keyup.enter)="searchHistory()"
        placeholder="Search history..." 
        class="search-input">
      <button class="search-btn" (click)="searchHistory()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
    </div>
    <button class="sort-btn" (click)="toggleHistorySort()" [title]="historySortOrder === 'desc' ? 'Newest First' : 'Oldest First'">
      <svg *ngIf="historySortOrder === 'desc'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <polyline points="19 12 12 19 5 12"></polyline>
      </svg>
      <svg *ngIf="historySortOrder === 'asc'" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="19" x2="12" y2="5"></line>
        <polyline points="5 12 12 5 19 12"></polyline>
      </svg>
    </button>
  </div>

  <div class="history-list" (scroll)="onHistoryScroll($event)">
    <div *ngIf="isHistoryLoading && historyItems.length === 0" class="loading-indicator">
      <div class="spinner"></div>
    </div>

    <div *ngIf="historyError" class="error-message">
      {{ historyError }}
    </div>

    <div *ngIf="!isHistoryLoading && historyItems.length === 0 && !historyError" class="empty-state-history">
      <p>No history available.</p>
    </div>

    <div *ngFor="let item of historyItems" class="history-card" (click)="onHistorySelected(item.id)">
      <div class="card-content" [title]="item.userMessage.length > 100 ? item.userMessage.substring(0, 1000) + (item.userMessage.length > 1000 ? '...' : '') : ''">
        <p class="message-text">
          {{ truncateHistory(item.userMessage, 100) }}
        </p>
        <div class="card-footer">
          <span class="date">{{ item.createdAt | date:'short' }}</span>
          <button class="copy-btn" (click)="copyHistoryToClipboard(item.userMessage, $event)" title="Copy full message">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-feedback">Copied!</span>
          </button>
        </div>
      </div>
    </div>
    
    <div *ngIf="isHistoryLoading && historyItems.length > 0" class="loading-more">
       <div class="spinner-small"></div> Loading more...
    </div>
  </div>
</div>

<!-- Chat Sidebar -->
<app-chat-sidebar
  (chatSelected)="onChatSelected($event)"
  (sidebarToggled)="onSidebarToggled($event)"
></app-chat-sidebar>

<!-- Template Gallery (replaces empty state) -->
<!-- Template Gallery moved to separate component -->

<div class="editor-container" [class.sidebar-open]="sidebarOpen" [hidden]="!isEditorVisible">
  <!-- Floating Toolbar Toggle Button (Mobile) -->
  <button class="floating-toggle-btn" (click)="toggleToolbar()"
          [title]="isToolbarVisible ? 'Hide toolbar' : 'Show toolbar'">
    <!-- hamburger/menu icon when toolbar is hidden -->
    <svg *ngIf="!isToolbarVisible" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="7" x2="21" y2="7"></line>
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="17" x2="21" y2="17"></line>
    </svg>
    <!-- icon indicating "hide toolbar" (upward arrow) -->
    <svg *ngIf="isToolbarVisible" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="6 15 12 9 18 15"></polyline>
    </svg>
  </button>

  <div class="toolbar" *ngIf="isToolbarVisible">
    <!-- Logo and Back Button -->
    <div class="toolbar-group">
        <div class="toolbar-logo-item">
            <div class="logo-text">1min<span>cv.com</span></div>
        </div>
        <button class="toolbar-btn back-btn" (click)="goBackToGallery()" title="Back to Gallery">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5"></path>
                <path d="M12 19l-7-7 7-7"></path>
            </svg>
            <span class="back-text">Back</span>
        </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- Save Button -->
    <div class="toolbar-group">
         <button class="toolbar-btn save-btn" (click)="saveResume()" [disabled]="!isManualEdit || isSaving" title="Save Resume (Enabled only after manual edits)" [style.opacity]="(!isManualEdit || isSaving) ? 0.5 : 1" style="display: flex; align-items: center; gap: 5px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            <span style="font-weight: 600;">{{ isSaving ? 'Saving...' : 'Save' }}</span>
        </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- Template Selector -->
    <div class="toolbar-group">
      <app-template-dropdown 
        [currentTemplateName]="currentTemplateName" 
        (templateSelected)="onBackendTemplateSelected($event)">
      </app-template-dropdown>
    </div>

    <div class="toolbar-divider"></div>

    <!-- History Controls -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <button 
        class="toolbar-btn" 
        (click)="undo()" 
        [disabled]="!canUndo()"
        title="Undo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 7v6h6"></path>
          <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
        </svg>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="redo()" 
        [disabled]="!canRedo()"
        title="Redo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 7v6h-6"></path>
          <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"></path>
        </svg>
      </button>
    </div>

    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Text Formatting -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <button 
        class="toolbar-btn" 
        (click)="toggleBold()" 
        [class.active]="isActive('bold')"
        title="Bold">
        <strong>B</strong>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="toggleItalic()" 
        [class.active]="isActive('italic')"
        title="Italic">
        <em>I</em>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="toggleUnderline()" 
        [class.active]="isActive('underline')"
        title="Underline">
        <u>U</u>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="toggleStrike()" 
        [class.active]="isActive('strike')"
        title="Strikethrough">
        <s>S</s>
      </button>
    </div>

    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Font Styling -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <!-- Font Family -->
      <select class="toolbar-select font-family-select" style="width: 140px;" (change)="setFontFamily($any($event.target).value)">
        <option value="" disabled selected>Font Family</option>
        <option value="Arial" style="font-family: Arial">Arial</option>
        <option value="Helvetica" style="font-family: Helvetica">Helvetica</option>
        <option value="Times New Roman" style="font-family: 'Times New Roman'">Times New Roman</option>
        <option value="Courier New" style="font-family: 'Courier New'">Courier New</option>
        <option value="Verdana" style="font-family: Verdana">Verdana</option>
        <option value="Georgia" style="font-family: Georgia">Georgia</option>
        <option value="Palatino" style="font-family: Palatino">Palatino</option>
        <option value="Garamond" style="font-family: Garamond">Garamond</option>
        <option value="Bookman" style="font-family: Bookman">Bookman</option>
        <option value="Comic Sans MS" style="font-family: 'Comic Sans MS'">Comic Sans MS</option>
        <option value="Trebuchet MS" style="font-family: 'Trebuchet MS'">Trebuchet MS</option>
        <option value="Arial Black" style="font-family: 'Arial Black'">Arial Black</option>
        <option value="Impact" style="font-family: Impact">Impact</option>
      </select>

      <!-- Font Size -->
      <select class="toolbar-select font-size-select" style="width: 80px;" (change)="setFontSize($any($event.target).value)">
        <option value="" disabled selected>Size</option>
        <option value="8pt">8pt</option>
        <option value="9pt">9pt</option>
        <option value="10pt">10pt</option>
        <option value="11pt">11pt</option>
        <option value="12pt">12pt</option>
        <option value="14pt">14pt</option>
        <option value="16pt">16pt</option>
        <option value="18pt">18pt</option>
        <option value="24pt">24pt</option>
        <option value="30pt">30pt</option>
        <option value="36pt">36pt</option>
        <option value="48pt">48pt</option>
        <option value="60pt">60pt</option>
        <option value="72pt">72pt</option>
      </select>
    </div>

    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Heading Styles -->
  <div class="toolbar-group" *ngIf="!isFormEditMode">
      <select class="toolbar-select" [ngModel]="currentHeadingValue" (ngModelChange)="setHeadingValue($event)">
        <option value="paragraph">Paragraph</option>
        <option value="1">Heading 1</option>
        <option value="2">Heading 2</option>
        <option value="3">Heading 3</option>
        <option value="4">Heading 4</option>
        <option value="5">Heading 5</option>
        <option value="6">Heading 6</option>
      </select>
    </div>

    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Lists -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <button 
        class="toolbar-btn" 
        (click)="toggleBulletList()" 
        [class.active]="isActive('bulletList')"
        title="Bullet List">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"></line>
          <line x1="8" y1="12" x2="21" y2="12"></line>
          <line x1="8" y1="18" x2="21" y2="18"></line>
          <circle cx="4" cy="6" r="1" fill="currentColor"></circle>
          <circle cx="4" cy="12" r="1" fill="currentColor"></circle>
          <circle cx="4" cy="18" r="1" fill="currentColor"></circle>
        </svg>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="toggleOrderedList()" 
        [class.active]="isActive('orderedList')"
        title="Numbered List">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="10" y1="6" x2="21" y2="6"></line>
          <line x1="10" y1="12" x2="21" y2="12"></line>
          <line x1="10" y1="18" x2="21" y2="18"></line>
          <path d="M4 6h1v4"></path>
          <path d="M4 10h2"></path>
          <path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path>
        </svg>
      </button>
    </div>

    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Text Alignment -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <button 
        class="toolbar-btn" 
        (click)="setTextAlign('left')" 
        [class.active]="isActive('textAlign', { textAlign: 'left' })"
        title="Align Left">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="15" y2="12"></line>
          <line x1="3" y1="18" x2="18" y2="18"></line>
        </svg>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="setTextAlign('center')" 
        [class.active]="isActive('textAlign', { textAlign: 'center' })"
        title="Align Center">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="6" y1="12" x2="18" y2="12"></line>
          <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="setTextAlign('right')" 
        [class.active]="isActive('textAlign', { textAlign: 'right' })"
        title="Align Right">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="9" y1="12" x2="21" y2="12"></line>
          <line x1="6" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      <button 
        class="toolbar-btn" 
        (click)="setTextAlign('justify')" 
        [class.active]="isActive('textAlign', { textAlign: 'justify' })"
        title="Justify">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Insert Options -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <button 
        class="toolbar-btn" 
        (click)="setLink()" 
        [class.active]="isActive('link')"
        title="Insert Link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </button>

      <div class="toolbar-dropdown-container" (mouseleave)="isTableGridOpen = false">
        <button 
          class="toolbar-btn" 
          (click)="toggleTableGrid()" 
          [class.active]="isTableGridOpen"
          title="Insert Table">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="3" y1="15" x2="21" y2="15"></line>
            <line x1="12" y1="3" x2="12" y2="21"></line>
          </svg>
        </button>
        
        <!-- Table Grid Selector Popup -->
        <div class="table-grid-popup" *ngIf="isTableGridOpen">
          <div class="grid-label">{{tableGridHover.cols || 0}} x {{tableGridHover.rows || 0}}</div>
          <div class="grid-row" *ngFor="let r of [1,2,3,4,5,6,7,8,9,10]">
            <div class="grid-cell" 
                 *ngFor="let c of [1,2,3,4,5,6,7,8,9,10]"
                 (mouseenter)="onTableGridHover(r, c)"
                 (click)="insertCustomTable(r, c)"
                 [class.active]="r <= tableGridHover.rows && c <= tableGridHover.cols">
            </div>
          </div>
        </div>
      </div>
      <button 
        class="toolbar-btn" 
        (click)="setHorizontalRule()" 
        title="Horizontal Rule">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="12" x2="21" y2="12"></line>
        </svg>
      </button>
    </div>

    <!-- Table Operations (Visible only when inside a table) -->
    <div class="toolbar-divider" *ngIf="isActive('table')"></div>
    <div class="toolbar-group" *ngIf="isActive('table')">
      <!-- Delete Table -->
      <button class="toolbar-btn" (click)="deleteTable()" title="Delete Table">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </button>

      <!-- Row Operations -->
      <button class="toolbar-btn" (click)="addRowBefore()" title="Add Row Before">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
          <path d="M3 9h18"></path>
        </svg>
      </button>
      <button class="toolbar-btn" (click)="addRowAfter()" title="Add Row After">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
          <path d="M3 15h18"></path>
        </svg>
      </button>
      <button class="toolbar-btn" (click)="deleteRow()" title="Delete Row">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <path d="M12 3v18"></path>
          <line x1="5" y1="7" x2="19" y2="7" stroke="red"></line>
        </svg>
      </button>

      <!-- Column Operations -->
      <button class="toolbar-btn" (click)="addColumnBefore()" title="Add Column Before">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
          <path d="M9 3v18"></path>
        </svg>
      </button>
      <button class="toolbar-btn" (click)="addColumnAfter()" title="Add Column After">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
          <path d="M15 3v18"></path>
        </svg>
      </button>
      <button class="toolbar-btn" (click)="deleteColumn()" title="Delete Column">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="12" y1="3" x2="12" y2="21"></line>
          <path d="M3 12h18"></path>
          <line x1="7" y1="5" x2="7" y2="19" stroke="red"></line>
        </svg>
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- Blockquote -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <button 
        class="toolbar-btn" 
        (click)="toggleBlockquote()" 
        [class.active]="isActive('blockquote')"
        title="Blockquote">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"></path>
          <path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"></path>
        </svg>
      </button>
    </div>

    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Download -->
    <div class="toolbar-group">
      <!-- Hidden as per user request
      <button 
        class="toolbar-btn download-btn" 
        (click)="downloadDocx()" 
        title="Download as DOCX (Best for simple text templates)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span class="download-label">DOCX</span>
      </button> -->
      <button 
        class="toolbar-btn download-btn" 
        (click)="downloadPdf()" 
        title="Download as PDF (Best for templates with graphics and styling)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span class="download-label">PDF</span>
      </button>
    </div>
    
    <div class="toolbar-divider"></div>


    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- Enhancement Mode Toggle -->
    <div class="toolbar-group" *ngIf="!isFormEditMode">
      <button 
        class="toolbar-btn enhancement-mode-toggle" 
        (click)="toggleEnhancementMode()" 
        [class.active]="useHtmlMode"
        [title]="useHtmlMode ? 'HTML Mode: Using enhancedHtml from API' : 'JSON Mode: Preserving your styling'"
        style="width: auto; padding: 0 8px; gap: 4px;">
        <svg *ngIf="!useHtmlMode" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="12" y1="18" x2="12" y2="12"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        <svg *ngIf="useHtmlMode" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        <span style="font-size: 11px; font-weight: 600;">{{ useHtmlMode ? 'HTML' : 'JSON' }}</span>
      </button>
    </div>
    
    <div class="toolbar-divider" *ngIf="!isFormEditMode"></div>

    <!-- History Toggle -->
    <div class="toolbar-group">
      <button 
        class="toolbar-btn" 
        (click)="toggleHistorySidebar()" 
        [class.active]="historySidebarOpen"
        title="View Enhancement History"
        style="width: auto; padding: 0 8px; gap: 4px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span>History</span>
      </button>
    </div>
  </div>

  <!-- Editor Content Area -->
  <div class="editor-wrapper">
    <div class="editor" [hidden]="isFormEditMode"></div>
    <div *ngIf="isFormEditMode" class="form-template-container" id="form-template-container">
        <!-- Dynamic Component Container -->
        <ng-template #dynamicFormContainer></ng-template>
    </div>
  </div>

  <!-- Chat Interface -->
  <div class="chat-interface">
    <div class="chat-container">
      <div class="chat-input-wrapper">
        <textarea 
          class="chat-input" 
          [(ngModel)]="chatInput" 
          (keydown)="handleChatKeydown($event)"
          placeholder="Ask AI to update your resume (e.g., 'Make the summary more professional')"
          [disabled]="isSending"
          rows="1"></textarea>
        <button 
          class="chat-send-btn" 
          (click)="sendMessage()" 
          [disabled]="!chatInput.trim() || isSending">
          <svg *ngIf="!isSending" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
          <span *ngIf="isSending" class="spinner"></span>
        </button>
      </div>
    </div>
  </div>
</div>

