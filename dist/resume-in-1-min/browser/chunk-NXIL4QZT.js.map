{
  "version": 3,
  "sources": ["src/app/billing/services/benefits.service.ts", "src/app/auth/auth.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\r\nimport { PlanBenefit } from '../../models/billing.models';\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class BenefitsService {\r\n  private benefits: PlanBenefit = {};\r\n\r\n  set(benefits: PlanBenefit) {\r\n    this.benefits = benefits;\r\n  }\r\n\r\n  get(code: string): number {\r\n    return Number(this.benefits[code] ?? 0);\r\n  }\r\n\r\n  has(code: string): boolean {\r\n    return Number(this.benefits[code]) > 0;\r\n  }\r\n}\r\n", "import { Injectable } from '@angular/core';\r\nimport { Observable, throwError } from 'rxjs';\r\nimport { map, tap, catchError } from 'rxjs/operators';\r\nimport { Router } from '@angular/router';\r\nimport { HttpService, ApiResponse } from '../services/http.service';\r\nimport { StateService, User } from '../services/state.service';\r\nimport { BillingApiService } from '../billing/services/billing-api.service';\r\nimport { BenefitsService } from '../billing/services/benefits.service';\r\n\r\n// ============================================\r\n// DTOs (Data Transfer Objects)\r\n// ============================================\r\n\r\nexport interface LoginDto {\r\n  email: string;\r\n  password: string;\r\n}\r\n\r\nexport interface RegisterDto {\r\n  firstName: string;\r\n  lastName: string;\r\n  email: string;\r\n  phone?: string;\r\n  password: string;\r\n  confirmPassword: string;\r\n}\r\n\r\n\r\nexport interface ForgotPasswordDto {\r\n  email: string;\r\n}\r\n\r\nexport interface ResetPasswordDto {\r\n  email: string;\r\n  token: string;\r\n  password: string;\r\n  confirmPassword: string;\r\n}\r\n\r\nexport interface LoginResponse {\r\n  token: string;\r\n  refreshToken?: string;\r\n  user: User;\r\n}\r\n\r\nexport interface RegisterResponse {\r\n  token: string;\r\n  refreshToken?: string;\r\n  user: User;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  \r\n  // Expose observables from StateService\r\n  public currentUser$ = this.stateService.user$;\r\n  public isAuthenticated$ = this.stateService.isAuthenticated$;\r\n\r\n  constructor(\r\n    private httpService: HttpService,\r\n    private stateService: StateService,\r\n    private billingApi: BillingApiService,\r\n    private benefitsService: BenefitsService,\r\n    private router: Router\r\n  ) {\r\n    console.log('üîê AuthService initialized');\r\n  }\r\n\r\n  // ============================================\r\n  // AUTHENTICATION METHODS\r\n  // ============================================\r\n\r\n  /**\r\n   * Login user\r\n   * POST /api/account/login\r\n   */\r\n  login(credentials: LoginDto): Observable<ApiResponse<LoginResponse>> {\r\n    console.log('üîê AuthService.login called');\r\n    return this.httpService.post<ApiResponse<LoginResponse>>(\r\n      'account/login',\r\n      credentials\r\n    ).pipe(\r\n      tap(response => {\r\n        console.log('üîê AuthService received response:', response);\r\n        if (response.status && response.data) {\r\n          console.log('üîê Response has status=true and data');\r\n          const { token, refreshToken, user } = response.data;\r\n          console.log('üîê Extracted token:', token ? 'Present' : 'Missing');\r\n          console.log('üîê Extracted user:', user);\r\n          console.log('üîê Calling setAuthState...');\r\n          this.stateService.setAuthState(token, user, refreshToken);\r\n          this.loadUserBenefits();\r\n          console.log('‚úÖ Login successful, state saved for:', user.email);\r\n        } else {\r\n          console.log('‚ö†Ô∏è Response status is false or no data');\r\n        }\r\n      }),\r\n      catchError(this.handleError)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Register new user\r\n   * POST /api/account/register\r\n   */\r\n  register(userData: RegisterDto): Observable<ApiResponse<RegisterResponse>> {\r\n    return this.httpService.post<ApiResponse<RegisterResponse>>(\r\n      'account/register',\r\n      userData\r\n    ).pipe(\r\n      tap(response => {\r\n        if (response.status && response.data) {\r\n          const { token, refreshToken, user } = response.data;\r\n          this.stateService.setAuthState(token, user, refreshToken);\r\n          this.loadUserBenefits();\r\n          console.log('‚úÖ Registration successful:', user.email);\r\n        }\r\n      }),\r\n      catchError(this.handleError)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Logout user\r\n   */\r\n  logout(): void {\r\n    this.stateService.clearAuthState();\r\n    this.router.navigate(['/login']);\r\n    console.log('üîì User logged out');\r\n  }\r\n\r\n  /**\r\n   * Forgot password\r\n   * POST /api/account/forgot-password\r\n   */\r\n  forgotPassword(data: ForgotPasswordDto): Observable<ApiResponse> {\r\n    return this.httpService.post<ApiResponse>(\r\n      'account/forgot-password',\r\n      data\r\n    ).pipe(catchError(this.handleError));\r\n  }\r\n\r\n  /**\r\n   * Reset password\r\n   * POST /api/account/reset-password\r\n   */\r\n  resetPassword(data: ResetPasswordDto): Observable<ApiResponse> {\r\n    return this.httpService.post<ApiResponse>(\r\n      'account/reset-password',\r\n      data\r\n    ).pipe(catchError(this.handleError));\r\n  }\r\n\r\n  /**\r\n   * Refresh token\r\n   * GET /api/account/refresh-token\r\n   */\r\n  refreshToken(): Observable<ApiResponse<LoginResponse>> {\r\n    // We utilize the HttpOnly cookie for refresh token, so no need to send it in body\r\n    return this.httpService.get<ApiResponse<LoginResponse>>(\r\n      'account/refresh-token'\r\n    ).pipe(\r\n      tap(response => {\r\n        if (response.status && response.data) {\r\n          const { token, user } = response.data;\r\n          \r\n          // Update state with new access token\r\n          // Refresh token is handled server-side via cookies\r\n          this.stateService.setAuthState(token, user, undefined);\r\n          this.loadUserBenefits();\r\n          console.log('‚úÖ Token refreshed via cookie');\r\n        }\r\n      }),\r\n      catchError(this.handleError)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Verify Google Token\r\n   * POST /api/account/google/verify-token\r\n   */\r\n  verifyGoogleToken(token: string): Observable<ApiResponse<LoginResponse>> {\r\n    return this.httpService.post<ApiResponse<LoginResponse>>(\r\n      'account/google/verify-token',\r\n      { token }\r\n    ).pipe(\r\n      tap(response => {\r\n        if (response.status && response.data) {\r\n          const { token, refreshToken, user } = response.data;\r\n          this.stateService.setAuthState(token, user, refreshToken);\r\n          this.loadUserBenefits();\r\n          console.log('‚úÖ Google login successful:', user.email);\r\n        }\r\n      }),\r\n      catchError(this.handleError)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get Google Client ID from backend and decrypt it\r\n   * GET /api/account/google/clientid\r\n   */\r\n  getGoogleClientId(): Observable<string> {\r\n    return this.httpService.get<ApiResponse<string>>('account/google/clientid').pipe(\r\n      map(response => {\r\n        if (response.status && response.data) {\r\n          // Decrypt the ID using StateService decryption pattern\r\n          const decryptedId = this.stateService.decrypt(response.data);\r\n          return decryptedId;\r\n        }\r\n        throw new Error(response.message || 'Failed to fetch Google Client ID');\r\n      }),\r\n      catchError(this.handleError)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Update user profile\r\n   * PUT /api/account/profile\r\n   */\r\n  updateProfile(data: Partial<User>): Observable<ApiResponse<User>> {\r\n    return this.httpService.put<ApiResponse<User>>(\r\n      'account/profile',\r\n      data\r\n    ).pipe(\r\n      tap(response => {\r\n        if (response.status && response.data) {\r\n          this.stateService.updateUser(response.data);\r\n          console.log('‚úÖ Profile updated:', response.data.email);\r\n        }\r\n      }),\r\n      catchError(this.handleError)\r\n    );\r\n  }\r\n\r\n  // ============================================\r\n  // STATE ACCESSORS\r\n  // ============================================\r\n\r\n  /**\r\n   * Get current user value (synchronous)\r\n   */\r\n  public get currentUserValue(): User | null {\r\n    return this.stateService.getCurrentUser();\r\n  }\r\n\r\n  /**\r\n   * Check if user is authenticated\r\n   */\r\n  public isAuthenticated(): boolean {\r\n    console.log('üîê AuthService.isAuthenticated() called');\r\n    const token = this.getToken();\r\n    console.log('üîê Token:', token ? 'Present (length: ' + token.length + ')' : 'Missing');\r\n    \r\n    if (!token) {\r\n      console.log('‚ùå No token found');\r\n      return false;\r\n    }\r\n    \r\n    // Check if token is expired\r\n    const isExpired = this.stateService.isTokenExpired(token);\r\n    console.log('üîê Token expired:', isExpired);\r\n    \r\n    if (isExpired) {\r\n      console.warn('‚ö†Ô∏è Token expired');\r\n      return false;\r\n    }\r\n    \r\n    const stateAuth = this.stateService.isAuthenticated();\r\n    console.log('üîê StateService.isAuthenticated():', stateAuth);\r\n    return stateAuth;\r\n  }\r\n\r\n  /**\r\n   * Get stored authentication token\r\n   */\r\n  public getToken(): string | null {\r\n    return this.stateService.getToken();\r\n  }\r\n\r\n  /**\r\n   * Get refresh token\r\n   */\r\n  public getRefreshToken(): string | null {\r\n    return this.stateService.getRefreshToken();\r\n  }\r\n\r\n  /**\r\n   * Get token expiry date\r\n   */\r\n  public getTokenExpiry(): Date | null {\r\n    const token = this.getToken();\r\n    return token ? this.stateService.getTokenExpiry(token) : null;\r\n  }\r\n\r\n  // ============================================\r\n  // ERROR HANDLING\r\n  // ============================================\r\n\r\n  /**\r\n   * Handle HTTP errors\r\n   */\r\n  private handleError(error: any): Observable<never> {\r\n    let errorMessage = 'An error occurred';\r\n    \r\n    if (error instanceof Error) {\r\n      // This might be an error thrown by HttpService with a pre-formatted message\r\n      errorMessage = error.message;\r\n    } else if (error.error instanceof ErrorEvent) {\r\n      // Client-side error\r\n      errorMessage = error.error.message;\r\n    } else {\r\n      // Server-side error from HttpErrorResponse\r\n      const serverError = error.error;\r\n      if (serverError) {\r\n        if (serverError.errors) {\r\n          const validationErrors: string[] = [];\r\n          Object.keys(serverError.errors).forEach(key => {\r\n            const messages = serverError.errors[key];\r\n            if (Array.isArray(messages)) {\r\n              validationErrors.push(...messages);\r\n            } else {\r\n              validationErrors.push(messages);\r\n            }\r\n          });\r\n          errorMessage = validationErrors.length > 0 ? validationErrors.join(', ') : (serverError.title || errorMessage);\r\n        } else {\r\n          errorMessage = serverError.message || serverError.title || serverError.error || error.message || errorMessage;\r\n        }\r\n      } else {\r\n        errorMessage = error.message || errorMessage;\r\n      }\r\n    }\r\n    \r\n    // Clean up generic Angular error prefix if it exists\r\n    if (errorMessage.includes('Http failure response')) {\r\n      errorMessage = `Server Error: ${error.status || ''} ${error.statusText || ''}`.trim() || 'Connection failed';\r\n    }\r\n\r\n    console.error('‚ùå Auth Service Error:', error);\r\n    return throwError(() => new Error(errorMessage));\r\n  }\r\n\r\n  // ============================================\r\n  // UTILITY METHODS\r\n  // ============================================\r\n\r\n  /**\r\n   * Debug current auth state\r\n   */\r\n  debugAuthState(): void {\r\n    console.log('=== AUTH STATE DEBUG ===');\r\n    console.log('Authenticated:', this.isAuthenticated());\r\n    console.log('Current User:', this.currentUserValue);\r\n    console.log('Token:', this.getToken()?.substring(0, 20) + '...');\r\n    console.log('Token Expiry:', this.getTokenExpiry());\r\n    console.log('======================');\r\n  }\r\n\r\n  /**\r\n   * Load user benefits from subscription\r\n   */\r\n  public loadUserBenefits(): void {\r\n    this.billingApi.getMySubscription().subscribe({\r\n      next: (sub) => {\r\n        if (sub && sub.benefits) {\r\n          this.benefitsService.set(sub.benefits);\r\n          console.log('üéÅ Benefits loaded:', sub.benefits);\r\n        }\r\n      },\r\n      error: (err) => {\r\n        console.error('‚ùå Failed to load benefits:', err);\r\n      }\r\n    });\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": ["token"]
}
